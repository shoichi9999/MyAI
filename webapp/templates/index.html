<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Binance Algorithm Explorer</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background: #0d1117; color: #c9d1d9; font-family: 'Segoe UI', sans-serif; }
        .card { background: #161b22; border: 1px solid #30363d; }
        .card-header { background: #21262d; border-bottom: 1px solid #30363d; }
        .nav-tabs .nav-link { color: #8b949e; border: none; }
        .nav-tabs .nav-link.active { color: #58a6ff; background: transparent; border-bottom: 2px solid #58a6ff; }
        .btn-primary { background: #238636; border-color: #238636; }
        .btn-primary:hover { background: #2ea043; }
        .btn-danger { background: #da3633; border-color: #da3633; }
        .form-control, .form-select { background: #0d1117; color: #c9d1d9; border: 1px solid #30363d; }
        .form-control:focus, .form-select:focus { background: #0d1117; color: #c9d1d9; border-color: #58a6ff; box-shadow: 0 0 0 0.15rem rgba(88,166,255,.25); }
        .table { color: #c9d1d9; }
        .table thead th { border-color: #30363d; color: #8b949e; }
        .table td { border-color: #21262d; }
        .positive { color: #3fb950; }
        .negative { color: #f85149; }
        .log-container { max-height: 400px; overflow-y: auto; font-family: monospace; font-size: 0.85rem; background: #010409; padding: 10px; border-radius: 6px; }
        .log-entry { padding: 2px 0; border-bottom: 1px solid #161b22; }
        .badge-strategy { background: #1f6feb; }
        .pulse { animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .ranking-row:hover { background: #1c2128; }
        h1 { color: #f0f6fc; }
        .header-bar { background: #161b22; border-bottom: 1px solid #30363d; padding: 15px 0; margin-bottom: 25px; }
        .pine-code { background: #010409; color: #e6edf3; font-family: 'Consolas', 'Monaco', monospace; font-size: 0.82rem; padding: 15px; border-radius: 6px; white-space: pre; overflow-x: auto; max-height: 70vh; border: 1px solid #30363d; }
        .btn-pine { background: #1f6feb; border-color: #1f6feb; color: #fff; font-size: 0.75rem; padding: 2px 8px; }
        .btn-pine:hover { background: #388bfd; color: #fff; }
        .modal-content { background: #161b22; color: #c9d1d9; border: 1px solid #30363d; }
        .modal-header { border-bottom: 1px solid #30363d; }
        .modal-footer { border-top: 1px solid #30363d; }
        .btn-close { filter: invert(1); }
    </style>
</head>
<body>

<div class="header-bar">
    <div class="container">
        <div class="d-flex align-items-center justify-content-between">
            <h1 class="h4 mb-0">Binance Algorithm Explorer</h1>
            <span id="statusBadge" class="badge bg-secondary">Idle</span>
        </div>
    </div>
</div>

<div class="container-fluid px-4">
    <ul class="nav nav-tabs mb-4" id="mainTabs">
        <li class="nav-item">
            <a class="nav-link active" data-bs-toggle="tab" href="#tab-generate">Strategy Generator</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" data-bs-toggle="tab" href="#tab-results">Results</a>
        </li>
    </ul>

    <div class="tab-content">
        <!-- Strategy Generator Tab -->
        <div class="tab-pane fade show active" id="tab-generate">
            <div class="row">
                <div class="col-lg-4">
                    <div class="card mb-3">
                        <div class="card-header"><h6 class="mb-0">Auto-Compose Settings</h6></div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label class="form-label">Symbol</label>
                                <select id="genSymbol" class="form-select">
                                    {% for s in symbols %}
                                    <option value="{{ s }}" {% if s == 'BTCUSDT' %}selected{% endif %}>{{ s }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Data Period (days)</label>
                                <input type="number" id="genDays" class="form-control" value="7" min="1" max="90">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Trials (structure + params)</label>
                                <input type="number" id="genTrials" class="form-control" value="500" min="50" max="5000" step="50">
                            </div>
                            <p class="text-muted small">14種類の条件ブロック (RSI, EMA, MACD, BB等) を1〜4個組み合わせ、構造ごとOptunaで最適化します。</p>
                            <div class="d-grid gap-2">
                                <button id="btnStartGen" class="btn btn-primary btn-lg" onclick="startGeneration()">
                                    Start Generation
                                </button>
                                <button id="btnStopGen" class="btn btn-danger" onclick="stopGeneration()" style="display:none;">
                                    Stop
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-8">
                    <div class="card mb-3">
                        <div class="card-header d-flex justify-content-between">
                            <h6 class="mb-0">Generation Progress</h6>
                            <span id="genCount" class="badge bg-info">0 strategies</span>
                        </div>
                        <div class="card-body">
                            <div class="log-container" id="genLogContainer">
                                <div class="text-muted text-center py-3">Start generation to see results...</div>
                            </div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header"><h6 class="mb-0">Top Generated Strategies</h6></div>
                        <div class="card-body p-0">
                            <table class="table table-sm mb-0">
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>Strategy</th>
                                        <th>Symbol</th>
                                        <th>Score</th>
                                        <th>Return %</th>
                                        <th>Sharpe</th>
                                        <th>Win Rate</th>
                                        <th>Trades</th>
                                        <th>Max DD</th>
                                        <th>Pine</th>
                                    </tr>
                                </thead>
                                <tbody id="genRanking"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Results Tab -->
        <div class="tab-pane fade" id="tab-results">
            <div class="row">
                <div class="col-lg-3">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h6 class="mb-0">Saved Results</h6>
                            <button class="btn btn-sm btn-outline-info" onclick="loadResultFiles()">Refresh</button>
                        </div>
                        <div class="card-body p-0">
                            <div class="list-group list-group-flush" id="resultFileList">
                                <div class="text-muted text-center py-3">Loading...</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-9">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h6 class="mb-0" id="resultFileTitle">Select a file to view</h6>
                        </div>
                        <div class="card-body p-0">
                            <table class="table table-sm mb-0">
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>Strategy</th>
                                        <th>Symbol</th>
                                        <th>Score</th>
                                        <th>Return %</th>
                                        <th>Sharpe</th>
                                        <th>Win Rate</th>
                                        <th>Trades</th>
                                        <th>Max DD</th>
                                        <th>Pine</th>
                                        <th>Timestamp</th>
                                    </tr>
                                </thead>
                                <tbody id="resultFileContent"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>

<!-- PineScript Modal -->
<div class="modal fade" id="pineModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h6 class="modal-title" id="pineModalTitle">PineScript v5</h6>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <pre class="pine-code" id="pineCode">Loading...</pre>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-sm btn-outline-info" onclick="copyPineScript()">Copy to Clipboard</button>
                <button type="button" class="btn btn-sm btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
// ---- Data stores for PineScript ----
let genTopData = [];
let resultData = [];

// ---- Strategy Generation ----
let genPollInterval = null;

function startGeneration() {
    const symbol = document.getElementById('genSymbol').value;
    const days = parseInt(document.getElementById('genDays').value);
    const n_trials = parseInt(document.getElementById('genTrials').value);

    fetch('/api/generate/start', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({symbol, days, n_trials})
    }).then(r => r.json()).then(data => {
        if (data.success) {
            document.getElementById('btnStartGen').style.display = 'none';
            document.getElementById('btnStopGen').style.display = 'block';
            document.getElementById('statusBadge').className = 'badge bg-warning pulse';
            document.getElementById('statusBadge').textContent = 'Generating...';
            startGenPolling();
        } else {
            alert(data.error || 'Failed to start');
        }
    });
}

function stopGeneration() {
    fetch('/api/generate/stop', {method: 'POST'});
    document.getElementById('btnStartGen').style.display = 'block';
    document.getElementById('btnStopGen').style.display = 'none';
}

function startGenPolling() {
    if (genPollInterval) clearInterval(genPollInterval);
    genPollInterval = setInterval(pollGenStatus, 2000);
}

function pollGenStatus() {
    fetch('/api/generate/status').then(r => r.json()).then(data => {
        document.getElementById('genCount').textContent = data.results_count + ' strategies';

        // Log
        const logEl = document.getElementById('genLogContainer');
        if (data.log.length > 0) {
            logEl.innerHTML = data.log.map(l =>
                `<div class="log-entry">
                    <strong>${l.symbol}</strong>
                    Score: <span class="${l.best_value > 0 ? 'positive' : 'negative'}">${l.best_value}</span>
                    Return: <span class="${l.return_pct > 0 ? 'positive' : 'negative'}">${l.return_pct}%</span>
                    Sharpe: ${l.sharpe} WR: ${l.win_rate}%
                    <small class="text-muted">${l.strategy.substring(0, 60)}</small>
                </div>`
            ).reverse().join('');
        }

        // Top ranking
        const top = data.top || [];
        genTopData = top;
        document.getElementById('genRanking').innerHTML = top.map((r, i) =>
            `<tr class="ranking-row">
                <td>${i + 1}</td>
                <td><small>${r.strategy.substring(0, 50)}</small></td>
                <td>${r.symbol}</td>
                <td class="${r.best_value > 0 ? 'positive' : 'negative'}">${r.best_value}</td>
                <td class="${r.return_pct > 0 ? 'positive' : 'negative'}">${r.return_pct}%</td>
                <td>${r.sharpe}</td>
                <td>${r.win_rate}%</td>
                <td>${r.total_trades}</td>
                <td class="negative">${r.max_dd}%</td>
                <td>${r.params ? `<button class="btn btn-pine" onclick="showPineScript(genTopData[${i}].params, genTopData[${i}].strategy)">Pine</button>` : ''}</td>
            </tr>`
        ).join('') || '<tr><td colspan="10" class="text-center py-3">Generating...</td></tr>';

        if (!data.is_running) {
            clearInterval(genPollInterval);
            document.getElementById('btnStartGen').style.display = 'block';
            document.getElementById('btnStopGen').style.display = 'none';
            document.getElementById('statusBadge').className = 'badge bg-secondary';
            document.getElementById('statusBadge').textContent = 'Completed';
        }
    });
}

// ---- Results Browser ----
function loadResultFiles() {
    fetch('/api/results/files').then(r => r.json()).then(data => {
        const files = data.files || [];
        const el = document.getElementById('resultFileList');
        if (files.length === 0) {
            el.innerHTML = '<div class="text-muted text-center py-3">No saved results yet.</div>';
            return;
        }
        el.innerHTML = files.map(f =>
            `<a href="#" class="list-group-item list-group-item-action"
                style="background:#161b22;color:#c9d1d9;border-color:#30363d;"
                onclick="loadResultFile('${f.name}');return false;">
                <div class="d-flex justify-content-between">
                    <small>${f.name}</small>
                    <span class="badge bg-secondary">${f.size_kb} KB</span>
                </div>
            </a>`
        ).join('');
    });
}

function loadResultFile(fname) {
    document.getElementById('resultFileTitle').textContent = fname;
    document.getElementById('resultFileContent').innerHTML =
        '<tr><td colspan="10" class="text-center py-3">Loading...</td></tr>';

    fetch('/api/results/load?file=' + encodeURIComponent(fname)).then(r => r.json()).then(data => {
        if (data.error) {
            document.getElementById('resultFileContent').innerHTML =
                `<tr><td colspan="10" class="text-center py-3 negative">${data.error}</td></tr>`;
            return;
        }
        const results = data.results || [];
        resultData = results;
        document.getElementById('resultFileContent').innerHTML = results.map((r, i) =>
            `<tr class="ranking-row">
                <td>${i + 1}</td>
                <td><small>${(r.strategy || '').substring(0, 50)}</small></td>
                <td>${r.symbol || ''}</td>
                <td class="${(r.best_value || 0) > 0 ? 'positive' : 'negative'}">${(r.best_value || 0).toFixed(4)}</td>
                <td class="${(r.metrics?.return_pct || r.metrics?.total_return_pct || 0) > 0 ? 'positive' : 'negative'}">
                    ${(r.metrics?.return_pct || r.metrics?.total_return_pct || 0).toFixed(2)}%</td>
                <td>${(r.metrics?.sharpe_ratio || 0).toFixed(4)}</td>
                <td>${(r.metrics?.win_rate || 0).toFixed(1)}%</td>
                <td>${r.metrics?.total_trades || 0}</td>
                <td class="negative">${(r.metrics?.max_drawdown_pct || 0).toFixed(2)}%</td>
                <td>${r.params ? `<button class="btn btn-pine" onclick="showPineScript(resultData[${i}].params, resultData[${i}].strategy)">Pine</button>` : ''}</td>
                <td><small>${r.timestamp || ''}</small></td>
            </tr>`
        ).join('') || '<tr><td colspan="11" class="text-center py-3">No results in this file.</td></tr>';
    });
}

// ---- PineScript ----
function showPineScript(params, title) {
    document.getElementById('pineCode').textContent = 'Loading...';
    document.getElementById('pineModalTitle').textContent = 'PineScript v5 — ' + (title || 'Strategy').substring(0, 60);
    new bootstrap.Modal(document.getElementById('pineModal')).show();

    fetch('/api/pinescript', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({params, title: title || 'Generated Strategy'})
    }).then(r => r.json()).then(data => {
        if (data.error) {
            document.getElementById('pineCode').textContent = 'Error: ' + data.error;
        } else {
            document.getElementById('pineCode').textContent = data.pinescript;
        }
    }).catch(e => {
        document.getElementById('pineCode').textContent = 'Error: ' + e.message;
    });
}

function copyPineScript() {
    const code = document.getElementById('pineCode').textContent;
    navigator.clipboard.writeText(code).then(() => {
        const btn = document.querySelector('#pineModal .btn-outline-info');
        btn.textContent = 'Copied!';
        setTimeout(() => { btn.textContent = 'Copy to Clipboard'; }, 2000);
    });
}

// Init
document.querySelector('[href="#tab-results"]').addEventListener('click', () => setTimeout(loadResultFiles, 200));
</script>
</body>
</html>
