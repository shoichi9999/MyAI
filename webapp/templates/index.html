<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Binance Algorithm Explorer</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/plotly.js-dist@2.27.0/plotly.min.js"></script>
    <style>
        body { background: #0d1117; color: #c9d1d9; font-family: 'Segoe UI', sans-serif; }
        .card { background: #161b22; border: 1px solid #30363d; }
        .card-header { background: #21262d; border-bottom: 1px solid #30363d; }
        .nav-tabs .nav-link { color: #8b949e; border: none; }
        .nav-tabs .nav-link.active { color: #58a6ff; background: transparent; border-bottom: 2px solid #58a6ff; }
        .btn-primary { background: #238636; border-color: #238636; }
        .btn-primary:hover { background: #2ea043; }
        .btn-danger { background: #da3633; border-color: #da3633; }
        .form-control, .form-select { background: #0d1117; color: #c9d1d9; border: 1px solid #30363d; }
        .form-control:focus, .form-select:focus { background: #0d1117; color: #c9d1d9; border-color: #58a6ff; box-shadow: 0 0 0 0.15rem rgba(88,166,255,.25); }
        .table { color: #c9d1d9; }
        .table thead th { border-color: #30363d; color: #8b949e; }
        .table td { border-color: #21262d; }
        .metric-card { background: #21262d; border-radius: 8px; padding: 15px; text-align: center; }
        .metric-value { font-size: 1.8rem; font-weight: bold; }
        .metric-label { font-size: 0.85rem; color: #8b949e; }
        .positive { color: #3fb950; }
        .negative { color: #f85149; }
        .log-container { max-height: 400px; overflow-y: auto; font-family: monospace; font-size: 0.85rem; background: #010409; padding: 10px; border-radius: 6px; }
        .log-entry { padding: 2px 0; border-bottom: 1px solid #161b22; }
        .badge-strategy { background: #1f6feb; }
        .pulse { animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .ranking-row:hover { background: #1c2128; }
        h1 { color: #f0f6fc; }
        .header-bar { background: #161b22; border-bottom: 1px solid #30363d; padding: 15px 0; margin-bottom: 25px; }
    </style>
</head>
<body>

<div class="header-bar">
    <div class="container">
        <div class="d-flex align-items-center justify-content-between">
            <h1 class="h4 mb-0">Binance Algorithm Explorer</h1>
            <span id="statusBadge" class="badge bg-secondary">Idle</span>
        </div>
    </div>
</div>

<div class="container-fluid px-4">
    <ul class="nav nav-tabs mb-4" id="mainTabs">
        <li class="nav-item">
            <a class="nav-link active" data-bs-toggle="tab" href="#tab-explore">AI Explorer</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" data-bs-toggle="tab" href="#tab-generate">Strategy Generator</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" data-bs-toggle="tab" href="#tab-backtest">Manual Backtest</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" data-bs-toggle="tab" href="#tab-ranking">Ranking</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" data-bs-toggle="tab" href="#tab-results">Results</a>
        </li>
    </ul>

    <div class="tab-content">
        <!-- AI Explorer Tab -->
        <div class="tab-pane fade show active" id="tab-explore">
            <div class="row">
                <div class="col-lg-4">
                    <div class="card mb-3">
                        <div class="card-header"><h6 class="mb-0">Exploration Settings</h6></div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label class="form-label">Symbols</label>
                                <select id="exploreSymbols" class="form-select" multiple size="6">
                                    {% for s in symbols %}
                                    <option value="{{ s }}" selected>{{ s }}</option>
                                    {% endfor %}
                                </select>
                                <small class="text-muted">Ctrl+Click for multi-select</small>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Strategies</label>
                                <select id="exploreStrategies" class="form-select" multiple size="6">
                                    {% for s in strategies %}
                                    <option value="{{ s }}" selected>{{ s }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Data Period (days)</label>
                                <input type="number" id="exploreDays" class="form-control" value="7" min="1" max="90">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Trials per strategy</label>
                                <input type="number" id="exploreTrials" class="form-control" value="50" min="10" max="500">
                            </div>
                            <div class="d-grid gap-2">
                                <button id="btnStartExplore" class="btn btn-primary btn-lg" onclick="startExploration()">
                                    Start Exploration
                                </button>
                                <button id="btnStopExplore" class="btn btn-danger" onclick="stopExploration()" style="display:none;">
                                    Stop
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-8">
                    <div class="card mb-3">
                        <div class="card-header d-flex justify-content-between">
                            <h6 class="mb-0">Live Log</h6>
                            <span id="logCount" class="badge bg-info">0 results</span>
                        </div>
                        <div class="card-body">
                            <div class="log-container" id="logContainer"></div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header"><h6 class="mb-0">Top Results (Live)</h6></div>
                        <div class="card-body p-0">
                            <table class="table table-sm mb-0">
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>Strategy</th>
                                        <th>Symbol</th>
                                        <th>Sharpe</th>
                                        <th>Return %</th>
                                        <th>Win Rate</th>
                                        <th>Trades</th>
                                    </tr>
                                </thead>
                                <tbody id="liveRanking"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Manual Backtest Tab -->
        <div class="tab-pane fade" id="tab-backtest">
            <div class="row">
                <div class="col-lg-4">
                    <div class="card">
                        <div class="card-header"><h6 class="mb-0">Backtest Parameters</h6></div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label class="form-label">Strategy</label>
                                <select id="btStrategy" class="form-select" onchange="loadDefaultParams()">
                                    {% for s in strategies %}
                                    <option value="{{ s }}">{{ s }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Symbol</label>
                                <input type="text" id="btSymbol" class="form-control" value="BTCUSDT">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Period (days)</label>
                                <input type="number" id="btDays" class="form-control" value="7" min="1" max="90">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Parameters (JSON)</label>
                                <textarea id="btParams" class="form-control" rows="4">{}</textarea>
                            </div>
                            <div class="d-grid">
                                <button class="btn btn-primary" onclick="runBacktest()">Run Backtest</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-8">
                    <div id="btResultArea" style="display:none;">
                        <div class="row mb-3" id="btMetrics"></div>
                        <div class="card">
                            <div class="card-header"><h6 class="mb-0">Result Details</h6></div>
                            <div class="card-body">
                                <pre id="btResultJson" style="color:#c9d1d9; max-height:500px; overflow:auto;"></pre>
                            </div>
                        </div>
                    </div>
                    <div id="btLoading" style="display:none;" class="text-center py-5">
                        <div class="spinner-border text-info" role="status"></div>
                        <p class="mt-2">Running backtest...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Strategy Generator Tab -->
        <div class="tab-pane fade" id="tab-generate">
            <div class="row">
                <div class="col-lg-4">
                    <div class="card mb-3">
                        <div class="card-header"><h6 class="mb-0">Auto-Compose Settings</h6></div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label class="form-label">Symbol</label>
                                <select id="genSymbol" class="form-select">
                                    {% for s in symbols %}
                                    <option value="{{ s }}" {% if s == 'BTCUSDT' %}selected{% endif %}>{{ s }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Data Period (days)</label>
                                <input type="number" id="genDays" class="form-control" value="7" min="1" max="90">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Trials (structure + params)</label>
                                <input type="number" id="genTrials" class="form-control" value="500" min="50" max="5000" step="50">
                            </div>
                            <p class="text-muted small">14種類の条件ブロック (RSI, EMA, MACD, BB等) を1〜4個組み合わせ、構造ごとOptunaで最適化します。</p>
                            <div class="d-grid gap-2">
                                <button id="btnStartGen" class="btn btn-primary btn-lg" onclick="startGeneration()">
                                    Start Generation
                                </button>
                                <button id="btnStopGen" class="btn btn-danger" onclick="stopGeneration()" style="display:none;">
                                    Stop
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-8">
                    <div class="card mb-3">
                        <div class="card-header d-flex justify-content-between">
                            <h6 class="mb-0">Generation Progress</h6>
                            <span id="genCount" class="badge bg-info">0 strategies</span>
                        </div>
                        <div class="card-body">
                            <div class="log-container" id="genLogContainer">
                                <div class="text-muted text-center py-3">Start generation to see results...</div>
                            </div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header"><h6 class="mb-0">Top Generated Strategies</h6></div>
                        <div class="card-body p-0">
                            <table class="table table-sm mb-0">
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>Strategy</th>
                                        <th>Symbol</th>
                                        <th>Score</th>
                                        <th>Return %</th>
                                        <th>Sharpe</th>
                                        <th>Win Rate</th>
                                        <th>Trades</th>
                                        <th>Max DD</th>
                                    </tr>
                                </thead>
                                <tbody id="genRanking"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Ranking Tab -->
        <div class="tab-pane fade" id="tab-ranking">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h6 class="mb-0">Exploration Ranking</h6>
                    <button class="btn btn-sm btn-outline-info" onclick="loadRanking()">Refresh</button>
                </div>
                <div class="card-body p-0">
                    <table class="table table-sm mb-0">
                        <thead>
                            <tr>
                                <th>Rank</th>
                                <th>Strategy</th>
                                <th>Symbol</th>
                                <th>Sharpe Ratio</th>
                                <th>Return %</th>
                                <th>Win Rate %</th>
                                <th>Trades</th>
                                <th>Max DD %</th>
                                <th>Profit Factor</th>
                                <th>Params</th>
                            </tr>
                        </thead>
                        <tbody id="rankingTable"></tbody>
                    </table>
                </div>
            </div>
        </div>
        <!-- Results Tab -->
        <div class="tab-pane fade" id="tab-results">
            <div class="row">
                <div class="col-lg-3">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h6 class="mb-0">Saved Results</h6>
                            <button class="btn btn-sm btn-outline-info" onclick="loadResultFiles()">Refresh</button>
                        </div>
                        <div class="card-body p-0">
                            <div class="list-group list-group-flush" id="resultFileList">
                                <div class="text-muted text-center py-3">Loading...</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-9">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h6 class="mb-0" id="resultFileTitle">Select a file to view</h6>
                        </div>
                        <div class="card-body p-0">
                            <table class="table table-sm mb-0">
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>Strategy</th>
                                        <th>Symbol</th>
                                        <th>Score</th>
                                        <th>Return %</th>
                                        <th>Sharpe</th>
                                        <th>Win Rate</th>
                                        <th>Trades</th>
                                        <th>Max DD</th>
                                        <th>Timestamp</th>
                                    </tr>
                                </thead>
                                <tbody id="resultFileContent"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
let pollInterval = null;

// ---- AI Exploration ----
function startExploration() {
    const symbols = Array.from(document.getElementById('exploreSymbols').selectedOptions).map(o => o.value);
    const strategies = Array.from(document.getElementById('exploreStrategies').selectedOptions).map(o => o.value);
    const days = parseInt(document.getElementById('exploreDays').value);
    const n_trials = parseInt(document.getElementById('exploreTrials').value);

    fetch('/api/explore/start', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({symbols, strategies, days, n_trials})
    }).then(r => r.json()).then(data => {
        if (data.success) {
            document.getElementById('btnStartExplore').style.display = 'none';
            document.getElementById('btnStopExplore').style.display = 'block';
            document.getElementById('statusBadge').className = 'badge bg-success pulse';
            document.getElementById('statusBadge').textContent = 'Exploring...';
            startPolling();
        } else {
            alert(data.error || 'Failed to start');
        }
    });
}

function stopExploration() {
    fetch('/api/explore/stop', {method: 'POST'});
    document.getElementById('btnStartExplore').style.display = 'block';
    document.getElementById('btnStopExplore').style.display = 'none';
}

function startPolling() {
    if (pollInterval) clearInterval(pollInterval);
    pollInterval = setInterval(pollStatus, 2000);
}

function pollStatus() {
    fetch('/api/explore/status').then(r => r.json()).then(data => {
        document.getElementById('logCount').textContent = data.log.length + ' results';

        // Log
        const logEl = document.getElementById('logContainer');
        logEl.innerHTML = data.log.map(l =>
            `<div class="log-entry">
                <span class="badge badge-strategy">${l.strategy}</span>
                <strong>${l.symbol}</strong>
                Sharpe: <span class="${l.best_value > 0 ? 'positive' : 'negative'}">${l.best_value}</span>
                Return: <span class="${l.total_return_pct > 0 ? 'positive' : 'negative'}">${l.total_return_pct}%</span>
                WR: ${l.win_rate}% (${l.total_trades} trades)
            </div>`
        ).reverse().join('');

        // Live ranking (top 10)
        const sorted = [...data.log].sort((a, b) => b.best_value - a.best_value).slice(0, 10);
        document.getElementById('liveRanking').innerHTML = sorted.map((r, i) =>
            `<tr class="ranking-row">
                <td>${i + 1}</td>
                <td><span class="badge badge-strategy">${r.strategy}</span></td>
                <td>${r.symbol}</td>
                <td class="${r.best_value > 0 ? 'positive' : 'negative'}">${r.best_value}</td>
                <td class="${r.total_return_pct > 0 ? 'positive' : 'negative'}">${r.total_return_pct}%</td>
                <td>${r.win_rate}%</td>
                <td>${r.total_trades}</td>
            </tr>`
        ).join('');

        if (!data.is_running) {
            clearInterval(pollInterval);
            document.getElementById('btnStartExplore').style.display = 'block';
            document.getElementById('btnStopExplore').style.display = 'none';
            document.getElementById('statusBadge').className = 'badge bg-secondary';
            document.getElementById('statusBadge').textContent = 'Completed';
        }
    });
}

// ---- Manual Backtest ----
function loadDefaultParams() {
    const strategy = document.getElementById('btStrategy').value;
    fetch('/api/strategies').then(r => r.json()).then(data => {
        const s = data.strategies.find(s => s.name === strategy);
        if (s) {
            document.getElementById('btParams').value = JSON.stringify(s.default_params, null, 2);
        }
    });
}

function runBacktest() {
    const strategy = document.getElementById('btStrategy').value;
    const symbol = document.getElementById('btSymbol').value;
    const days = parseInt(document.getElementById('btDays').value);
    let params = {};
    try { params = JSON.parse(document.getElementById('btParams').value); } catch(e) {}

    document.getElementById('btLoading').style.display = 'block';
    document.getElementById('btResultArea').style.display = 'none';

    fetch('/api/backtest', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({strategy, symbol, days, params})
    }).then(r => r.json()).then(data => {
        document.getElementById('btLoading').style.display = 'none';
        if (data.success) {
            showBacktestResult(data.result);
        } else {
            alert(data.error || 'Backtest failed');
        }
    }).catch(err => {
        document.getElementById('btLoading').style.display = 'none';
        alert('Error: ' + err.message);
    });
}

function showBacktestResult(result) {
    document.getElementById('btResultArea').style.display = 'block';

    const metrics = [
        {label: 'Total Return', value: result.total_return_pct + '%', positive: result.total_return_pct > 0},
        {label: 'Sharpe Ratio', value: result.sharpe_ratio, positive: result.sharpe_ratio > 0},
        {label: 'Win Rate', value: result.win_rate + '%', positive: result.win_rate > 50},
        {label: 'Max Drawdown', value: result.max_drawdown_pct + '%', positive: false},
        {label: 'Total Trades', value: result.total_trades, positive: true},
        {label: 'Profit Factor', value: result.profit_factor, positive: result.profit_factor > 1},
    ];

    document.getElementById('btMetrics').innerHTML = metrics.map(m =>
        `<div class="col-md-2 mb-2">
            <div class="metric-card">
                <div class="metric-value ${m.positive ? 'positive' : 'negative'}">${m.value}</div>
                <div class="metric-label">${m.label}</div>
            </div>
        </div>`
    ).join('');

    document.getElementById('btResultJson').textContent = JSON.stringify(result, null, 2);
}

// ---- Ranking ----
function loadRanking() {
    fetch('/api/explore/results?top_n=30').then(r => r.json()).then(data => {
        const results = data.results || [];
        document.getElementById('rankingTable').innerHTML = results.map((r, i) =>
            `<tr class="ranking-row">
                <td><strong>${i + 1}</strong></td>
                <td><span class="badge badge-strategy">${r.strategy}</span></td>
                <td>${r.symbol}</td>
                <td class="${r.best_value > 0 ? 'positive' : 'negative'}">${r.best_value?.toFixed(4)}</td>
                <td class="${r.metrics?.total_return_pct > 0 ? 'positive' : 'negative'}">${r.metrics?.total_return_pct}%</td>
                <td>${r.metrics?.win_rate}%</td>
                <td>${r.metrics?.total_trades}</td>
                <td class="negative">${r.metrics?.max_drawdown_pct}%</td>
                <td>${r.metrics?.profit_factor}</td>
                <td><small>${JSON.stringify(r.best_params)}</small></td>
            </tr>`
        ).join('') || '<tr><td colspan="10" class="text-center py-3">No results yet. Run an exploration first.</td></tr>';
    });
}

// ---- Strategy Generation ----
let genPollInterval = null;

function startGeneration() {
    const symbol = document.getElementById('genSymbol').value;
    const days = parseInt(document.getElementById('genDays').value);
    const n_trials = parseInt(document.getElementById('genTrials').value);

    fetch('/api/generate/start', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({symbol, days, n_trials})
    }).then(r => r.json()).then(data => {
        if (data.success) {
            document.getElementById('btnStartGen').style.display = 'none';
            document.getElementById('btnStopGen').style.display = 'block';
            document.getElementById('statusBadge').className = 'badge bg-warning pulse';
            document.getElementById('statusBadge').textContent = 'Generating...';
            startGenPolling();
        } else {
            alert(data.error || 'Failed to start');
        }
    });
}

function stopGeneration() {
    fetch('/api/generate/stop', {method: 'POST'});
    document.getElementById('btnStartGen').style.display = 'block';
    document.getElementById('btnStopGen').style.display = 'none';
}

function startGenPolling() {
    if (genPollInterval) clearInterval(genPollInterval);
    genPollInterval = setInterval(pollGenStatus, 2000);
}

function pollGenStatus() {
    fetch('/api/generate/status').then(r => r.json()).then(data => {
        document.getElementById('genCount').textContent = data.results_count + ' strategies';

        // Log
        const logEl = document.getElementById('genLogContainer');
        if (data.log.length > 0) {
            logEl.innerHTML = data.log.map(l =>
                `<div class="log-entry">
                    <strong>${l.symbol}</strong>
                    Score: <span class="${l.best_value > 0 ? 'positive' : 'negative'}">${l.best_value}</span>
                    Return: <span class="${l.return_pct > 0 ? 'positive' : 'negative'}">${l.return_pct}%</span>
                    Sharpe: ${l.sharpe} WR: ${l.win_rate}%
                    <small class="text-muted">${l.strategy.substring(0, 60)}</small>
                </div>`
            ).reverse().join('');
        }

        // Top ranking
        const top = data.top || [];
        document.getElementById('genRanking').innerHTML = top.map((r, i) =>
            `<tr class="ranking-row">
                <td>${i + 1}</td>
                <td><small>${r.strategy.substring(0, 50)}</small></td>
                <td>${r.symbol}</td>
                <td class="${r.best_value > 0 ? 'positive' : 'negative'}">${r.best_value}</td>
                <td class="${r.return_pct > 0 ? 'positive' : 'negative'}">${r.return_pct}%</td>
                <td>${r.sharpe}</td>
                <td>${r.win_rate}%</td>
                <td>${r.total_trades}</td>
                <td class="negative">${r.max_dd}%</td>
            </tr>`
        ).join('') || '<tr><td colspan="9" class="text-center py-3">Generating...</td></tr>';

        if (!data.is_running) {
            clearInterval(genPollInterval);
            document.getElementById('btnStartGen').style.display = 'block';
            document.getElementById('btnStopGen').style.display = 'none';
            document.getElementById('statusBadge').className = 'badge bg-secondary';
            document.getElementById('statusBadge').textContent = 'Completed';
        }
    });
}

// ---- Results Browser ----
function loadResultFiles() {
    fetch('/api/results/files').then(r => r.json()).then(data => {
        const files = data.files || [];
        const el = document.getElementById('resultFileList');
        if (files.length === 0) {
            el.innerHTML = '<div class="text-muted text-center py-3">No saved results yet.</div>';
            return;
        }
        el.innerHTML = files.map(f =>
            `<a href="#" class="list-group-item list-group-item-action"
                style="background:#161b22;color:#c9d1d9;border-color:#30363d;"
                onclick="loadResultFile('${f.name}');return false;">
                <div class="d-flex justify-content-between">
                    <small>${f.name}</small>
                    <span class="badge bg-secondary">${f.size_kb} KB</span>
                </div>
            </a>`
        ).join('');
    });
}

function loadResultFile(fname) {
    document.getElementById('resultFileTitle').textContent = fname;
    document.getElementById('resultFileContent').innerHTML =
        '<tr><td colspan="10" class="text-center py-3">Loading...</td></tr>';

    fetch('/api/results/load?file=' + encodeURIComponent(fname)).then(r => r.json()).then(data => {
        if (data.error) {
            document.getElementById('resultFileContent').innerHTML =
                `<tr><td colspan="10" class="text-center py-3 negative">${data.error}</td></tr>`;
            return;
        }
        const results = data.results || [];
        document.getElementById('resultFileContent').innerHTML = results.map((r, i) =>
            `<tr class="ranking-row">
                <td>${i + 1}</td>
                <td><small>${(r.strategy || '').substring(0, 50)}</small></td>
                <td>${r.symbol || ''}</td>
                <td class="${(r.best_value || 0) > 0 ? 'positive' : 'negative'}">${(r.best_value || 0).toFixed(4)}</td>
                <td class="${(r.metrics?.return_pct || r.metrics?.total_return_pct || 0) > 0 ? 'positive' : 'negative'}">
                    ${(r.metrics?.return_pct || r.metrics?.total_return_pct || 0).toFixed(2)}%</td>
                <td>${(r.metrics?.sharpe_ratio || 0).toFixed(4)}</td>
                <td>${(r.metrics?.win_rate || 0).toFixed(1)}%</td>
                <td>${r.metrics?.total_trades || 0}</td>
                <td class="negative">${(r.metrics?.max_drawdown_pct || 0).toFixed(2)}%</td>
                <td><small>${r.timestamp || ''}</small></td>
            </tr>`
        ).join('') || '<tr><td colspan="10" class="text-center py-3">No results in this file.</td></tr>';
    });
}

// Init
loadDefaultParams();
document.querySelector('[href="#tab-ranking"]').addEventListener('click', () => setTimeout(loadRanking, 200));
document.querySelector('[href="#tab-results"]').addEventListener('click', () => setTimeout(loadResultFiles, 200));
</script>
</body>
</html>
