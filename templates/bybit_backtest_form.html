{% extends "bybit_base.html" %}

{% block title %}バックテスト実行 - Bybit Futures Shorting{% endblock %}

{% block content %}
<div class="container">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h4 class="mb-0">
                        <i class="fas fa-chart-line"></i> Bybit アルトコイン/BTC先物 ショートバックテスト
                    </h4>
                </div>
                <div class="card-body">
                    <form method="POST" id="backtestForm">
                        <div class="row">
                            <!-- シンボル選択 -->
                            <div class="col-md-6">
                                <div class="card mb-4">
                                    <div class="card-header">
                                        <h6 class="mb-0">
                                            <i class="fas fa-coins"></i> 対象シンボル選択
                                        </h6>
                                    </div>
                                    <div class="card-body">
                                        {% if symbols %}
                                        <div class="mb-3">
                                            <div class="input-group">
                                                <span class="input-group-text"><i class="fas fa-search"></i></span>
                                                <input type="text" id="symbolSearch" class="form-control" placeholder="シンボル名で検索...">
                                            </div>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <button type="button" class="btn btn-outline-primary btn-sm me-2" onclick="selectPopular()">
                                                <i class="fas fa-star"></i> 人気ペア選択
                                            </button>
                                            <button type="button" class="btn btn-outline-secondary btn-sm me-2" onclick="selectTop20()">
                                                <i class="fas fa-chart-bar"></i> TOP20選択
                                            </button>
                                            <button type="button" class="btn btn-outline-danger btn-sm" onclick="clearSelection()">
                                                <i class="fas fa-times"></i> クリア
                                            </button>
                                        </div>
                                        
                                        <div style="max-height: 300px; overflow-y: auto;" class="border rounded p-2">
                                            {% for symbol in symbols[:30] %}
                                            <div class="form-check symbol-item">
                                                <input class="form-check-input symbol-checkbox" type="checkbox" 
                                                       name="symbols" value="{{ symbol.symbol }}" id="symbol_{{ loop.index }}">
                                                <label class="form-check-label" for="symbol_{{ loop.index }}">
                                                    <strong>{{ symbol.symbol }}</strong>
                                                    <small class="text-muted">({{ symbol.baseCoin }}/BTC)</small>
                                                </label>
                                            </div>
                                            {% endfor %}
                                            
                                            {% if symbols|length > 30 %}
                                            <div class="text-center mt-2">
                                                <small class="text-muted">
                                                    <i class="fas fa-info-circle"></i>
                                                    最初の30ペアのみ表示中
                                                    <a href="{{ url_for('list_symbols') }}" class="text-decoration-none">
                                                        全{{ symbols|length }}ペアを見る
                                                    </a>
                                                </small>
                                            </div>
                                            {% endif %}
                                        </div>
                                        
                                        <div class="mt-3">
                                            <small class="text-muted">
                                                <span id="selectedCount">0</span> シンボル選択中
                                            </small>
                                        </div>
                                        
                                        {% else %}
                                        <div class="alert alert-warning">
                                            <i class="fas fa-exclamation-triangle"></i>
                                            シンボルデータの読み込みに失敗しました。
                                            <a href="{{ url_for('list_symbols') }}" class="alert-link">シンボル一覧ページ</a>
                                            から選択してください。
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            
                            <!-- パラメータ設定 -->
                            <div class="col-md-6">
                                <div class="card mb-4">
                                    <div class="card-header">
                                        <h6 class="mb-0">
                                            <i class="fas fa-cogs"></i> バックテストパラメータ
                                        </h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="mb-3">
                                            <label for="days" class="form-label">
                                                <i class="fas fa-calendar"></i> バックテスト期間
                                            </label>
                                            <select name="days" id="days" class="form-select">
                                                <option value="7">7日間（短期）</option>
                                                <option value="14">14日間（中短期）</option>
                                                <option value="30" selected>30日間（中期）</option>
                                                <option value="60">60日間（長期）</option>
                                                <option value="90">90日間（超長期）</option>
                                            </select>
                                            <div class="form-text">データ量が多いほど分析精度が向上します</div>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label for="leverage" class="form-label">
                                                <i class="fas fa-chart-area"></i> レバレッジ倍率
                                            </label>
                                            <select name="leverage" id="leverage" class="form-select">
                                                <option value="1.0" selected>1倍（安全）</option>
                                                <option value="2.0">2倍（中リスク）</option>
                                                <option value="3.0">3倍（高リスク）</option>
                                                <option value="5.0">5倍（超高リスク）</option>
                                            </select>
                                            <div class="form-text">レバレッジが高いほどリスクも高くなります</div>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label for="max_symbols" class="form-label">
                                                <i class="fas fa-layer-group"></i> 最大同時分析数
                                            </label>
                                            <select name="max_symbols" id="max_symbols" class="form-select">
                                                <option value="5">5シンボル（高速）</option>
                                                <option value="10">10シンボル（標準）</option>
                                                <option value="20" selected>20シンボル（詳細）</option>
                                                <option value="30">30シンボル（包括的）</option>
                                                <option value="50">50シンボル（全面的）</option>
                                            </select>
                                            <div class="form-text">多いほど時間がかかりますが、より包括的な分析が可能</div>
                                        </div>
                                        
                                        <!-- 手数料設定 -->
                                        <div class="mb-3">
                                            <label class="form-label">
                                                <i class="fas fa-percentage"></i> 取引手数料
                                            </label>
                                            <div class="input-group">
                                                <span class="input-group-text">エントリー</span>
                                                <input type="text" class="form-control" value="0.06%" readonly>
                                                <span class="input-group-text">エグジット</span>
                                                <input type="text" class="form-control" value="0.06%" readonly>
                                            </div>
                                            <div class="form-text">Bybit先物標準手数料（0.06%）を使用</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- 実行ボタン -->
                                <div class="card">
                                    <div class="card-body text-center">
                                        <button type="submit" class="btn btn-success btn-lg" id="submitButton" disabled>
                                            <i class="fas fa-rocket"></i> バックテスト開始
                                        </button>
                                        <div class="mt-2">
                                            <small class="text-muted">
                                                <i class="fas fa-clock"></i> 
                                                実行時間: 約<span id="estimatedTime">-</span>分
                                            </small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 説明カード -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="fas fa-info-circle"></i> ショート戦略について
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <h6><i class="fas fa-chart-line text-success"></i> ショート戦略とは</h6>
                            <p class="small">価格下落時に利益を得る投資戦略。アルトコインがビットコインに対して下落する局面で収益を狙います。</p>
                        </div>
                        <div class="col-md-4">
                            <h6><i class="fas fa-shield-alt text-info"></i> リスク管理</h6>
                            <p class="small">レバレッジ1倍での安全な取引を推奨。取引手数料やスリッページも考慮した現実的な分析を行います。</p>
                        </div>
                        <div class="col-md-4">
                            <h6><i class="fas fa-chart-bar text-warning"></i> 評価指標</h6>
                            <p class="small">総リターン、シャープレシオ、最大ドローダウン、勝率など多角的な指標で戦略を評価します。</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// 人気ペア（例）
const popularSymbols = ['ETHBTC', 'ADABTC', 'DOTBTC', 'LINKBTC', 'LTCBTC', 'EOSBTC', 'XRPBTC', 'BCHBTC'];

// シンボル検索
document.getElementById('symbolSearch').addEventListener('input', function() {
    const filter = this.value.toLowerCase();
    const items = document.querySelectorAll('.symbol-item');
    
    items.forEach(item => {
        const text = item.textContent.toLowerCase();
        item.style.display = text.includes(filter) ? '' : 'none';
    });
});

// 人気ペア選択
function selectPopular() {
    clearSelection();
    const checkboxes = document.querySelectorAll('.symbol-checkbox');
    checkboxes.forEach(checkbox => {
        if (popularSymbols.includes(checkbox.value)) {
            checkbox.checked = true;
        }
    });
    updateUI();
}

// TOP20選択
function selectTop20() {
    clearSelection();
    const checkboxes = document.querySelectorAll('.symbol-checkbox');
    for (let i = 0; i < Math.min(20, checkboxes.length); i++) {
        checkboxes[i].checked = true;
    }
    updateUI();
}

// 選択クリア
function clearSelection() {
    const checkboxes = document.querySelectorAll('.symbol-checkbox');
    checkboxes.forEach(checkbox => {
        checkbox.checked = false;
    });
    updateUI();
}

// UI更新
function updateUI() {
    const checkedBoxes = document.querySelectorAll('.symbol-checkbox:checked');
    const count = checkedBoxes.length;
    const maxSymbols = parseInt(document.getElementById('max_symbols').value);
    
    // 選択数表示
    document.getElementById('selectedCount').textContent = count;
    
    // 実行ボタン状態
    const submitButton = document.getElementById('submitButton');
    submitButton.disabled = count === 0;
    
    // 実行時間予測
    const estimatedMinutes = Math.ceil(Math.min(count, maxSymbols) * 0.5);
    document.getElementById('estimatedTime').textContent = estimatedMinutes;
    
    // 警告表示
    if (count > maxSymbols) {
        if (!document.getElementById('maxSymbolWarning')) {
            const warning = document.createElement('div');
            warning.id = 'maxSymbolWarning';
            warning.className = 'alert alert-warning mt-2';
            warning.innerHTML = `
                <i class="fas fa-exclamation-triangle"></i>
                選択数が最大分析数(${maxSymbols})を超えています。最初の${maxSymbols}個のみ分析されます。
            `;
            document.getElementById('selectedCount').parentElement.appendChild(warning);
        }
    } else {
        const existing = document.getElementById('maxSymbolWarning');
        if (existing) existing.remove();
    }
}

// イベントリスナー設定
document.addEventListener('DOMContentLoaded', function() {
    // チェックボックス変更イベント
    const checkboxes = document.querySelectorAll('.symbol-checkbox');
    checkboxes.forEach(checkbox => {
        checkbox.addEventListener('change', updateUI);
    });
    
    // 最大分析数変更イベント
    document.getElementById('max_symbols').addEventListener('change', updateUI);
    
    // フォーム送信前検証
    document.getElementById('backtestForm').addEventListener('submit', function(e) {
        const checkedBoxes = document.querySelectorAll('.symbol-checkbox:checked');
        
        if (checkedBoxes.length === 0) {
            e.preventDefault();
            alert('少なくとも1つのシンボルを選択してください。');
            return false;
        }
        
        // 実行確認
        const count = checkedBoxes.length;
        const maxSymbols = parseInt(document.getElementById('max_symbols').value);
        const actualCount = Math.min(count, maxSymbols);
        const days = document.getElementById('days').value;
        const leverage = document.getElementById('leverage').value;
        
        const message = `
バックテストを実行しますか？

対象シンボル: ${actualCount}個
期間: ${days}日間
レバレッジ: ${leverage}倍
予想実行時間: 約${Math.ceil(actualCount * 0.5)}分

※実行中はページを閉じないでください。
        `;
        
        if (!confirm(message)) {
            e.preventDefault();
            return false;
        }
        
        // 実行ボタンを無効化し、ローディング表示
        const submitButton = document.getElementById('submitButton');
        submitButton.disabled = true;
        submitButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 実行中...';
    });
    
    // 初期UI更新
    updateUI();
});
</script>
{% endblock %}