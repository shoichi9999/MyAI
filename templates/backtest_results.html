{% extends "base.html" %}

{% block title %}バックテスト結果 - ビットコインバックテスト{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <!-- ページタイトル -->
        <div class="card mb-4">
            <div class="card-body text-center">
                <h2>
                    <i class="fas fa-chart-line"></i> バックテスト結果
                </h2>
                <p class="lead mb-0">{{ strategy_name }} - {{ start_date }} から {{ end_date }}</p>
            </div>
        </div>
    </div>
</div>

<!-- パフォーマンス要約カード -->
<div class="row mb-4">
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="performance-card">
            <div class="metric-value">{{ "%.2f"|format(results.total_return_pct) }}%</div>
            <div class="metric-label">総リターン</div>
        </div>
    </div>
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="performance-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
            <div class="metric-value">{{ "%.3f"|format(results.sharpe_ratio) }}</div>
            <div class="metric-label">シャープレシオ</div>
        </div>
    </div>
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="performance-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
            <div class="metric-value">{{ "%.2f"|format(results.max_drawdown_pct) }}%</div>
            <div class="metric-label">最大ドローダウン</div>
        </div>
    </div>
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="performance-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
            <div class="metric-value">{{ results.num_trades }}</div>
            <div class="metric-label">取引回数</div>
        </div>
    </div>
</div>

<!-- チャートセクション -->
<div class="row">
    <div class="col-12 mb-4">
        <div class="chart-container">
            <h4 class="mb-3">
                <i class="fas fa-chart-candlestick"></i> 価格チャートと取引シグナル
            </h4>
            {{ price_chart|safe }}
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-6 mb-4">
        <div class="chart-container">
            <h4 class="mb-3">
                <i class="fas fa-chart-area"></i> エクイティカーブ
            </h4>
            {{ equity_chart|safe }}
        </div>
    </div>
    <div class="col-md-6 mb-4">
        <div class="chart-container">
            <h4 class="mb-3">
                <i class="fas fa-chart-line"></i> ドローダウン
            </h4>
            {{ drawdown_chart|safe }}
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-6 mb-4">
        <div class="chart-container">
            <h4 class="mb-3">
                <i class="fas fa-calendar-alt"></i> 月次リターン
            </h4>
            {{ monthly_returns_chart|safe }}
        </div>
    </div>
    <div class="col-md-6 mb-4">
        <div class="chart-container">
            <h4 class="mb-3">
                <i class="fas fa-exchange-alt"></i> 取引統計
            </h4>
            {{ trade_analysis_chart|safe }}
        </div>
    </div>
</div>

<!-- 詳細パフォーマンステーブル -->
<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-table"></i> 詳細パフォーマンス指標
                </h5>
            </div>
            <div class="card-body">
                {{ performance_table|safe }}
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-cog"></i> 実行設定
                </h5>
            </div>
            <div class="card-body">
                <table class="table table-sm">
                    <tr>
                        <td><strong>戦略:</strong></td>
                        <td>{{ strategy_name }}</td>
                    </tr>
                    <tr>
                        <td><strong>期間:</strong></td>
                        <td>{{ start_date }} - {{ end_date }}</td>
                    </tr>
                    <tr>
                        <td><strong>初期資金:</strong></td>
                        <td>{{ "{:,.0f}".format(results.initial_capital) }} 円</td>
                    </tr>
                    <tr>
                        <td><strong>最終資産価値:</strong></td>
                        <td>{{ "{:,.0f}".format(results.final_value) }} 円</td>
                    </tr>
                    <tr>
                        <td><strong>総手数料:</strong></td>
                        <td>{{ "{:,.2f}".format(results.total_commission) }} 円</td>
                    </tr>
                </table>
                
                {% if strategy_params %}
                <h6 class="mt-3">戦略パラメータ:</h6>
                <table class="table table-sm">
                    {% for key, value in strategy_params.items() %}
                    <tr>
                        <td><strong>{{ key }}:</strong></td>
                        <td>{{ value }}</td>
                    </tr>
                    {% endfor %}
                </table>
                {% endif %}
            </div>
        </div>
        
        <!-- アクションボタン -->
        <div class="card mt-3">
            <div class="card-body text-center">
                <h6>アクション</h6>
                <div class="d-grid gap-2">
                    <a href="{{ url_for('run_backtest') }}" class="btn btn-primary">
                        <i class="fas fa-redo"></i> 新しいバックテスト
                    </a>
                    <a href="{{ url_for('strategy_comparison') }}" class="btn btn-success">
                        <i class="fas fa-balance-scale"></i> 戦略比較
                    </a>
                    <button class="btn btn-info" onclick="window.print()">
                        <i class="fas fa-print"></i> レポート印刷
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 取引履歴（最新10件） -->
{% if recent_trades %}
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-history"></i> 最近の取引履歴
                </h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>日時</th>
                                <th>アクション</th>
                                <th>数量 (BTC)</th>
                                <th>価格 (USD)</th>
                                <th>手数料</th>
                                <th>総額</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for trade in recent_trades %}
                            <tr>
                                <td>{{ trade.timestamp.strftime('%Y-%m-%d %H:%M') }}</td>
                                <td>
                                    {% if trade.action == 'BUY' %}
                                        <span class="badge bg-success">買い</span>
                                    {% else %}
                                        <span class="badge bg-danger">売り</span>
                                    {% endif %}
                                </td>
                                <td>{{ "%.6f"|format(trade.quantity) }}</td>
                                <td>${{ "{:,.0f}".format(trade.price) }}</td>
                                <td>{{ "{:,.2f}".format(trade.commission) }}</td>
                                <td>${{ "{:,.0f}".format(trade.quantity * trade.price) }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- サマリーカード -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-md-3">
                        <h6 class="text-muted">実行時刻</h6>
                        <p class="mb-0"><strong>{{ execution_time }}</strong></p>
                    </div>
                    <div class="col-md-3">
                        <h6 class="text-muted">データ件数</h6>
                        <p class="mb-0"><strong>{{ data_points }} 日</strong></p>
                    </div>
                    <div class="col-md-3">
                        <h6 class="text-muted">Buy&Hold比較</h6>
                        <p class="mb-0">
                            <strong class="{% if results.excess_return_pct > 0 %}text-success{% else %}text-danger{% endif %}">
                                {{ "{:+.2f}".format(results.excess_return_pct) }}%
                            </strong>
                        </p>
                    </div>
                    <div class="col-md-3">
                        <h6 class="text-muted">ステータス</h6>
                        <p class="mb-0">
                            <span class="badge bg-success">完了</span>
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    @media print {
        .navbar, .footer, .btn, .card-header {
            display: none !important;
        }
        .card {
            border: 1px solid #ddd !important;
            box-shadow: none !important;
        }
    }
    
    .performance-card {
        transition: transform 0.3s ease;
    }
    
    .performance-card:hover {
        transform: translateY(-5px);
    }
    
    .chart-container {
        transition: box-shadow 0.3s ease;
    }
    
    .chart-container:hover {
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    }
</style>
{% endblock %}