{% extends "bybit_base.html" %}

{% block title %}バックテスト結果 - Bybit Futures Shorting{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- ヘッダー情報 -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h4 class="mb-0">
                        <i class="fas fa-chart-line"></i> 
                        Bybit アルトコイン/BTC先物 ショートバックテスト結果
                    </h4>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <h6 class="text-muted">実行時刻</h6>
                            <p class="mb-0"><strong>{{ execution_time }}</strong></p>
                        </div>
                        <div class="col-md-3">
                            <h6 class="text-muted">分析シンボル数</h6>
                            <p class="mb-0"><strong>{{ total_symbols }}ペア</strong></p>
                        </div>
                        <div class="col-md-3">
                            <h6 class="text-muted">バックテスト期間</h6>
                            <p class="mb-0"><strong>{{ days }}日間</strong></p>
                        </div>
                        <div class="col-md-3">
                            <h6 class="text-muted">レバレッジ倍率</h6>
                            <p class="mb-0"><strong>{{ leverage }}倍</strong></p>
                        </div>
                    </div>
                    
                    <div class="mt-3">
                        <a href="{{ url_for('run_backtest') }}" class="btn btn-primary me-2">
                            <i class="fas fa-redo"></i> 新しいバックテスト
                        </a>
                        <a href="{{ url_for('futures_leaderboard') }}" class="btn btn-warning">
                            <i class="fas fa-trophy"></i> リーダーボード
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    {% if results %}
    <!-- サマリー統計 -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h5 class="card-title text-success">最高リターン</h5>
                    <h3 class="performance-positive">
                        {{ "%.2f"|format(results[0].total_return_pct) }}%
                    </h3>
                    <p class="card-text">{{ results[0].symbol }}</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h5 class="card-title text-info">平均リターン</h5>
                    <h3>
                        {% set avg_return = (results | sum(attribute='total_return_pct')) / results|length %}
                        <span class="{{ 'performance-positive' if avg_return > 0 else 'performance-negative' }}">
                            {{ "%.2f"|format(avg_return) }}%
                        </span>
                    </h3>
                    <p class="card-text">{{ total_symbols }}ペア平均</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h5 class="card-title text-warning">勝率</h5>
                    <h3>
                        {% set winning_count = results | selectattr('total_return_pct', '>', 0) | list | length %}
                        {{ "%.1f"|format((winning_count / results|length) * 100) }}%
                    </h3>
                    <p class="card-text">{{ winning_count }}/{{ total_symbols }}ペア</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h5 class="card-title text-primary">最高シャープレシオ</h5>
                    <h3>
                        {% set best_sharpe = results | max(attribute='sharpe_ratio') %}
                        {{ "%.3f"|format(best_sharpe.sharpe_ratio) }}
                    </h3>
                    <p class="card-text">{{ best_sharpe.symbol }}</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- パフォーマンステーブル -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-table"></i> 詳細パフォーマンス分析
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover" id="resultsTable">
                            <thead class="table-dark">
                                <tr>
                                    <th width="60">順位</th>
                                    <th>シンボル</th>
                                    <th>ベースコイン</th>
                                    <th>総リターン</th>
                                    <th>シャープレシオ</th>
                                    <th>最大DD</th>
                                    <th>勝率</th>
                                    <th>ボラティリティ</th>
                                    <th>データ数</th>
                                    <th>期間</th>
                                    <th width="100">詳細</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for result in results %}
                                <tr>
                                    <td>
                                        <span class="badge {% if loop.index == 1 %}bg-warning{% elif loop.index == 2 %}bg-secondary{% elif loop.index == 3 %}bg-info{% else %}bg-light text-dark{% endif %}">
                                            {{ loop.index }}
                                        </span>
                                    </td>
                                    <td>
                                        <strong>{{ result.symbol }}</strong>
                                    </td>
                                    <td>
                                        <span class="badge bg-info">{{ result.symbol.replace('BTC', '') }}</span>
                                    </td>
                                    <td>
                                        <span class="{{ 'performance-positive' if result.total_return_pct > 0 else 'performance-negative' }}">
                                            {{ "%.2f"|format(result.total_return_pct) }}%
                                        </span>
                                    </td>
                                    <td>{{ "%.3f"|format(result.sharpe_ratio) }}</td>
                                    <td>
                                        <span class="performance-negative">
                                            {{ "%.2f"|format(result.max_drawdown_pct) }}%
                                        </span>
                                    </td>
                                    <td>{{ "%.1f"|format(result.win_rate) }}%</td>
                                    <td>{{ "%.2f"|format(result.volatility) }}</td>
                                    <td>{{ result.data_points }}</td>
                                    <td>
                                        <small>{{ result.start_date }}<br>{{ result.end_date }}</small>
                                    </td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-primary" onclick="showChart('{{ result.symbol }}', {{ loop.index0 }})">
                                            <i class="fas fa-chart-area"></i> チャート
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- チャート表示モーダル -->
    <div class="modal fade" id="chartModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="chartModalTitle">
                        <i class="fas fa-chart-line"></i> パフォーマンスチャート
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="performanceChart" style="height: 500px;"></div>
                    <div class="mt-3">
                        <div class="row">
                            <div class="col-md-6" id="chartStats">
                                <!-- 統計情報がここに表示される -->
                            </div>
                            <div class="col-md-6" id="chartInfo">
                                <!-- 追加情報がここに表示される -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    {% else %}
    <!-- 結果なし -->
    <div class="row">
        <div class="col-12">
            <div class="alert alert-warning text-center">
                <i class="fas fa-exclamation-triangle fa-3x mb-3"></i>
                <h4>バックテスト結果が見つかりません</h4>
                <p>選択したシンボルのデータ取得に失敗したか、計算エラーが発生した可能性があります。</p>
                <a href="{{ url_for('run_backtest') }}" class="btn btn-warning">
                    <i class="fas fa-redo"></i> 再実行
                </a>
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
// バックテスト結果データ（JavaScript用）
const resultsData = {{ results | tojson | safe }};

// チャート表示
function showChart(symbol, index) {
    const result = resultsData[index];
    
    // モーダルタイトル設定
    document.getElementById('chartModalTitle').innerHTML = 
        `<i class="fas fa-chart-line"></i> ${symbol} - ショートパフォーマンス`;
    
    // 累積リターンデータ準備
    const cumulativeReturns = result.cumulative_returns || [];
    const timestamps = Array.from({length: cumulativeReturns.length}, (_, i) => i + 1);
    
    // Plotlyチャート作成
    const trace1 = {
        x: timestamps,
        y: cumulativeReturns.map(r => (r - 1) * 100), // パーセント表示
        type: 'scatter',
        mode: 'lines',
        name: 'ショートリターン',
        line: {
            color: result.total_return_pct > 0 ? '#28a745' : '#dc3545',
            width: 2
        }
    };
    
    // ゼロライン
    const trace2 = {
        x: timestamps,
        y: Array(timestamps.length).fill(0),
        type: 'scatter',
        mode: 'lines',
        name: 'ベンチマーク (0%)',
        line: {
            color: '#6c757d',
            width: 1,
            dash: 'dash'
        }
    };
    
    const layout = {
        title: `${symbol} ショート戦略 累積リターン`,
        xaxis: {
            title: '期間（時間）',
            gridcolor: '#e9ecef'
        },
        yaxis: {
            title: '累積リターン (%)',
            gridcolor: '#e9ecef'
        },
        plot_bgcolor: '#ffffff',
        paper_bgcolor: '#ffffff',
        margin: { t: 50, r: 50, b: 50, l: 80 },
        legend: {
            x: 0.02,
            y: 0.98
        }
    };
    
    Plotly.newPlot('performanceChart', [trace1, trace2], layout, {responsive: true});
    
    // 統計情報表示
    document.getElementById('chartStats').innerHTML = `
        <h6><i class="fas fa-chart-bar"></i> パフォーマンス指標</h6>
        <ul class="list-unstyled">
            <li><strong>総リターン:</strong> <span class="${result.total_return_pct > 0 ? 'performance-positive' : 'performance-negative'}">${result.total_return_pct.toFixed(2)}%</span></li>
            <li><strong>シャープレシオ:</strong> ${result.sharpe_ratio.toFixed(3)}</li>
            <li><strong>最大ドローダウン:</strong> <span class="performance-negative">${result.max_drawdown_pct.toFixed(2)}%</span></li>
            <li><strong>勝率:</strong> ${result.win_rate.toFixed(1)}%</li>
            <li><strong>ボラティリティ:</strong> ${result.volatility.toFixed(2)}</li>
        </ul>
    `;
    
    document.getElementById('chartInfo').innerHTML = `
        <h6><i class="fas fa-info-circle"></i> データ情報</h6>
        <ul class="list-unstyled">
            <li><strong>データポイント:</strong> ${result.data_points}個</li>
            <li><strong>分析期間:</strong> ${result.start_date} ～ ${result.end_date}</li>
            <li><strong>データ頻度:</strong> 1時間足</li>
            <li><strong>レバレッジ:</strong> {{ leverage }}倍</li>
        </ul>
        
        <div class="mt-3">
            <h6><i class="fas fa-lightbulb"></i> 解釈</h6>
            <p class="small">
                ${result.total_return_pct > 0 
                    ? `このペアのショート戦略は期間中に${result.total_return_pct.toFixed(2)}%の利益を上げました。` 
                    : `このペアのショート戦略は期間中に${Math.abs(result.total_return_pct).toFixed(2)}%の損失となりました。`}
                シャープレシオ${result.sharpe_ratio.toFixed(3)}は、リスク調整後のパフォーマンスを示しています。
            </p>
        </div>
    `;
    
    // モーダル表示
    const modal = new bootstrap.Modal(document.getElementById('chartModal'));
    modal.show();
}

// テーブルソート機能
document.addEventListener('DOMContentLoaded', function() {
    // DataTablesがある場合は使用
    if (typeof $.fn.DataTable !== 'undefined') {
        $('#resultsTable').DataTable({
            "order": [[ 0, "asc" ]],
            "pageLength": 25,
            "responsive": true,
            "language": {
                "url": "//cdn.datatables.net/plug-ins/1.11.5/i18n/ja.json"
            }
        });
    }
    
    // パフォーマンスに基づく行の色付け
    const rows = document.querySelectorAll('#resultsTable tbody tr');
    rows.forEach(row => {
        const returnCell = row.querySelector('td:nth-child(4)');
        if (returnCell) {
            const returnValue = parseFloat(returnCell.textContent);
            if (returnValue > 5) {
                row.classList.add('table-success');
            } else if (returnValue < -5) {
                row.classList.add('table-danger');
            }
        }
    });
});
</script>

<!-- DataTables（オプション） -->
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap5.min.css">
<script type="text/javascript" src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script type="text/javascript" src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
<script type="text/javascript" src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap5.min.js"></script>
{% endblock %}