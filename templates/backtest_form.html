{% extends "base.html" %}

{% block title %}バックテスト実行 - ビットコインバックテスト{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-8 mx-auto">
        <div class="card">
            <div class="card-header">
                <h4 class="mb-0">
                    <i class="fas fa-play-circle"></i> バックテスト設定
                </h4>
            </div>
            <div class="card-body">
                <form method="POST" onsubmit="showLoading()">
                    <div class="row">
                        <!-- 戦略選択 -->
                        <div class="col-md-6 mb-3">
                            <label for="strategy" class="form-label">
                                <i class="fas fa-brain"></i> 戦略選択
                            </label>
                            <select class="form-select" id="strategy" name="strategy" required>
                                <option value="">戦略を選択してください（全41戦略）</option>
                                <optgroup label="基本戦略">
                                    <option value="sma_crossover">Simple Moving Average Crossover</option>
                                    <option value="ema_crossover">Exponential Moving Average Crossover</option>
                                    <option value="triple_sma">Triple Moving Average</option>
                                    <option value="rsi">RSI Strategy</option>
                                    <option value="macd">MACD Strategy</option>
                                    <option value="momentum">Price Momentum</option>
                                    <option value="bollinger_bands">Bollinger Bands</option>
                                    <option value="mean_reversion">Mean Reversion Strategy</option>
                                </optgroup>
                                <optgroup label="相関戦略">
                                    <option value="multi_asset_correlation">Multi-Asset Correlation Strategy</option>
                                    <option value="volatility_correlation">Volatility Correlation Strategy</option>
                                    <option value="volume_price_correlation">Volume-Price Correlation Strategy</option>
                                    <option value="cross_timeframe_correlation">Cross-Timeframe Correlation Strategy</option>
                                    <option value="sentiment_correlation">Sentiment Correlation Strategy</option>
                                    <option value="adaptive_correlation">Adaptive Correlation Strategy</option>
                                </optgroup>
                                <optgroup label="統計戦略">
                                    <option value="cointegration_pairs">Cointegration Pairs Strategy</option>
                                    <option value="regime_detection">Regime Detection Strategy</option>
                                    <option value="fractal_dimension">Fractal Dimension Strategy</option>
                                    <option value="entropy_based">Entropy-Based Strategy</option>
                                    <option value="kalman_filter">Kalman Filter Strategy</option>
                                    <option value="granger_causality">Granger Causality Strategy</option>
                                </optgroup>
                                <optgroup label="機械学習戦略">
                                    <option value="linear_regression">Linear Regression Strategy</option>
                                    <option value="knn_strategy">K-Nearest Neighbors Strategy</option>
                                    <option value="ensemble_ml">Ensemble ML Strategy</option>
                                    <option value="neural_network_simple">Simple Neural Network Strategy</option>
                                </optgroup>
                                <optgroup label="高度なテクニカル戦略">
                                    <option value="ichimoku_cloud">Ichimoku Cloud Strategy</option>
                                    <option value="elliott_wave">Elliott Wave Strategy</option>
                                    <option value="harmonic_pattern">Harmonic Pattern Strategy</option>
                                    <option value="market_profile">Market Profile Strategy</option>
                                    <option value="wyckoff_method">Wyckoff Method Strategy</option>
                                </optgroup>
                                <optgroup label="マーケットマイクロストラクチャー戦略">
                                    <option value="order_flow_imbalance">Order Flow Imbalance Strategy</option>
                                    <option value="volume_price_analysis">Volume Price Analysis Strategy</option>
                                    <option value="liquidity_provision">Liquidity Provision Strategy</option>
                                    <option value="tick_analysis">Tick Analysis Strategy</option>
                                    <option value="market_making">Market Making Strategy</option>
                                    <option value="high_frequency_momentum">High Frequency Momentum Strategy</option>
                                </optgroup>
                                <optgroup label="クオンタティブ戦略">
                                    <option value="factor_model">Multi-Factor Model Strategy</option>
                                    <option value="risk_parity">Risk Parity Strategy</option>
                                    <option value="black_litterman">Black-Litterman Strategy</option>
                                    <option value="copula_strategy">Copula-based Strategy</option>
                                    <option value="value_at_risk">Value at Risk Strategy</option>
                                    <option value="maximum_diversification">Maximum Diversification Strategy</option>
                                </optgroup>
                            </select>
                        </div>
                        
                        <!-- 初期資金 -->
                        <div class="col-md-6 mb-3">
                            <label for="initial_capital" class="form-label">
                                <i class="fas fa-yen-sign"></i> 初期資金
                            </label>
                            <input type="number" class="form-control" id="initial_capital" 
                                   name="initial_capital" value="1000000" min="10000" step="10000" required>
                            <div class="form-text">最小: 10,000円</div>
                        </div>
                        
                        <!-- 期間設定 -->
                        <div class="col-md-6 mb-3">
                            <label for="start_date" class="form-label">
                                <i class="fas fa-calendar-alt"></i> 開始日
                            </label>
                            <input type="date" class="form-control" id="start_date" 
                                   name="start_date" value="2023-01-01" required>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="end_date" class="form-label">
                                <i class="fas fa-calendar-alt"></i> 終了日
                            </label>
                            <input type="date" class="form-control" id="end_date" 
                                   name="end_date" value="2024-01-01" required>
                        </div>
                        
                        <!-- 手数料率 -->
                        <div class="col-md-6 mb-3">
                            <label for="commission_rate" class="form-label">
                                <i class="fas fa-percentage"></i> 手数料率
                            </label>
                            <input type="number" class="form-control" id="commission_rate" 
                                   name="commission_rate" value="0.001" min="0" max="0.01" step="0.0001" required>
                            <div class="form-text">0.1% = 0.001</div>
                        </div>
                        
                        <!-- データソース -->
                        <div class="col-md-6 mb-3">
                            <label for="data_source" class="form-label">
                                <i class="fas fa-database"></i> データソース
                            </label>
                            <select class="form-select" id="data_source" name="data_source" required>
                                <option value="yahoo" selected>Yahoo Finance</option>
                                <option value="binance" disabled>Binance (開発中)</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- 戦略別パラメータ -->
                    <div class="row mt-4">
                        <div class="col-12">
                            <h5 class="mb-3">
                                <i class="fas fa-sliders-h"></i> 戦略パラメータ
                            </h5>
                            
                            <!-- SMAクロスオーバーパラメータ -->
                            <div id="sma_crossover_params" class="strategy-params" style="display: none;">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">短期移動平均期間</label>
                                        <input type="number" class="form-control" name="short_window" value="20" min="5" max="50">
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">長期移動平均期間</label>
                                        <input type="number" class="form-control" name="long_window" value="50" min="20" max="200">
                                    </div>
                                </div>
                            </div>
                            
                            <!-- EMAクロスオーバーパラメータ -->
                            <div id="ema_crossover_params" class="strategy-params" style="display: none;">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">短期EMA期間</label>
                                        <input type="number" class="form-control" name="short_window" value="12" min="5" max="50">
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">長期EMA期間</label>
                                        <input type="number" class="form-control" name="long_window" value="26" min="20" max="200">
                                    </div>
                                </div>
                            </div>
                            
                            <!-- RSIパラメータ -->
                            <div id="rsi_params" class="strategy-params" style="display: none;">
                                <div class="row">
                                    <div class="col-md-4 mb-3">
                                        <label class="form-label">RSI期間</label>
                                        <input type="number" class="form-control" name="rsi_window" value="14" min="5" max="30">
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <label class="form-label">売られすぎ閾値</label>
                                        <input type="number" class="form-control" name="oversold_threshold" value="30" min="10" max="40">
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <label class="form-label">買われすぎ閾値</label>
                                        <input type="number" class="form-control" name="overbought_threshold" value="70" min="60" max="90">
                                    </div>
                                </div>
                            </div>
                            
                            <!-- MACDパラメータ -->
                            <div id="macd_params" class="strategy-params" style="display: none;">
                                <div class="row">
                                    <div class="col-md-4 mb-3">
                                        <label class="form-label">高速EMA期間</label>
                                        <input type="number" class="form-control" name="fast_period" value="12" min="5" max="20">
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <label class="form-label">低速EMA期間</label>
                                        <input type="number" class="form-control" name="slow_period" value="26" min="20" max="50">
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <label class="form-label">シグナル期間</label>
                                        <input type="number" class="form-control" name="signal_period" value="9" min="5" max="15">
                                    </div>
                                </div>
                            </div>
                            
                            <!-- ボリンジャーバンドパラメータ -->
                            <div id="bollinger_bands_params" class="strategy-params" style="display: none;">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">移動平均期間</label>
                                        <input type="number" class="form-control" name="window" value="20" min="10" max="50">
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">標準偏差倍数</label>
                                        <input type="number" class="form-control" name="num_std" value="2.0" min="1.0" max="3.0" step="0.1">
                                    </div>
                                </div>
                            </div>
                            
                            <!-- その他の戦略パラメータは省略（必要に応じて追加） -->
                            <div id="default_params" class="strategy-params">
                                <p class="text-muted">
                                    <i class="fas fa-info-circle"></i> 
                                    戦略を選択するとパラメータ設定が表示されます
                                </p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 実行ボタン -->
                    <div class="row mt-4">
                        <div class="col-12">
                            <div class="d-grid">
                                <button type="submit" class="btn btn-primary btn-lg">
                                    <i class="fas fa-rocket"></i> バックテスト実行
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- ローディング表示 -->
<div class="loading-spinner">
    <div class="text-center">
        <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status">
            <span class="visually-hidden">読み込み中...</span>
        </div>
        <p class="mt-3">バックテストを実行中です。しばらくお待ちください...</p>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // 戦略選択に応じてパラメータ表示を切り替え
    document.getElementById('strategy').addEventListener('change', function() {
        // 全てのパラメータセクションを非表示
        const allParams = document.querySelectorAll('.strategy-params');
        allParams.forEach(param => param.style.display = 'none');
        
        // 選択された戦略のパラメータを表示
        const selectedStrategy = this.value;
        if (selectedStrategy) {
            const paramDiv = document.getElementById(selectedStrategy + '_params');
            if (paramDiv) {
                paramDiv.style.display = 'block';
            }
        } else {
            document.getElementById('default_params').style.display = 'block';
        }
    });
    
    // デフォルトでdefault_paramsを表示
    document.getElementById('default_params').style.display = 'block';
    
    // 日付の妥当性チェック
    document.getElementById('end_date').addEventListener('change', function() {
        const startDate = new Date(document.getElementById('start_date').value);
        const endDate = new Date(this.value);
        
        if (endDate <= startDate) {
            alert('終了日は開始日より後の日付を選択してください。');
            this.value = '';
        }
    });
</script>
{% endblock %}